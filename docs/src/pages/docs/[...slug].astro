---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import SidebarTree from "../../components/SidebarTree.astro";
import type { TreeItem } from "../../components/SidebarTree.astro";
import { GITHUB_URL } from "../../data/info";

export async function getStaticPaths() {
	const entries = await getCollection("docs");
	return entries.map((entry) => ({
		params: { slug: entry.id },
		props: { entry },
	}));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

const allEntries = await getCollection("docs");

function prettifySection(name: string): string {
	return name
		.split("-")
		.map((w) => w.charAt(0).toUpperCase() + w.slice(1))
		.join(" ");
}

const sections = new Map<
	string,
	{
		label: string;
		children: { label: string; href: string; order: number }[];
	}
>();

for (const e of allEntries) {
	const parts = e.id.split("/");
	const sectionKey =
		parts.length > 1 ? parts.slice(0, -1).join("/") : "_root";
	const sectionLabel =
		sectionKey === "_root"
			? "Docs"
			: prettifySection(parts[parts.length - 2]);

	if (!sections.has(sectionKey)) {
		sections.set(sectionKey, { label: sectionLabel, children: [] });
	}

	sections.get(sectionKey)!.children.push({
		label: e.data.title,
		href: `/docs/${e.id}`,
		order: e.data.order,
	});
}

const SECTION_ORDER: Record<string, number> = {
	"getting-started": 0,
	"features": 1,
	"guides": 2,
};

const sidebarItems: TreeItem[] = [...sections.entries()]
	.map(([key, section]) => ({
		label: section.label,
		sectionOrder: SECTION_ORDER[key] ?? 99,
		children: section.children.sort((a, b) => a.order - b.order),
	}))
	.sort((a, b) => a.sectionOrder - b.sectionOrder)
	.map(({ label, children }) => ({
		label,
		children: children.map(({ label, href }) => ({ label, href })),
	}));
---

<Layout title={entry.data.title} description={`${entry.data.title} â€” lpm documentation`}>
	<div class="flex w-full lg:w-7xl mx-auto p-4 md:p-8 gap-8">
		<div class="hidden lg:block">
			<SidebarTree items={sidebarItems} />
		</div>
		<main class="w-full lg:w-4xl shrink-0 min-w-0 markdown">
			<Content />
			<div class="mt-12 pt-6 border-t border-black/10 dark:border-white/10 not-prose">
				<a
					href={`${GITHUB_URL}/edit/master/docs/src/content/docs/${entry.id}.md`}
					target="_blank"
					rel="noopener noreferrer"
					class="inline-flex items-center gap-1.5 text-sm text-black/40 dark:text-white/40 hover:text-black dark:hover:text-white transition-colors"
				>
					<svg xmlns="http://www.w3.org/2000/svg" class="size-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
						<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
					</svg>
					Edit this page
				</a>
			</div>
		</main>
	</div>
</Layout>
