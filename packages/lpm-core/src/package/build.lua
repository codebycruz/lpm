local fs = require("fs")
local path = require("path")

---@type table<lpm.Package, boolean>
local currentlyBuilding = setmetatable({}, { __mode = "k" })

---@param package lpm.Package
---@param destinationPath string?
local function buildPackage(package, destinationPath)
	if currentlyBuilding[package] then
		return
	end
	currentlyBuilding[package] = true

	destinationPath = destinationPath or path.join(package:getModulesDir(), package:getName())

	-- Ensure parent dir (target) exists
	local target = path.dirname(destinationPath)
	if not fs.isdir(target) then
		fs.mkdir(target)
	end

	local buildScriptPath = package:getBuildScriptPath()
	if fs.exists(buildScriptPath) then
		fs.copy(package:getSrcDir(), destinationPath)

		local ok, err = package:runScript(buildScriptPath, nil, { LPM_OUTPUT_DIR = destinationPath })
		if not ok then
			error("Build script failed for package '" .. package:getName() .. "': " .. err)
		end
	else
		fs.mklink(package:getSrcDir(), destinationPath)
	end

	currentlyBuilding[package] = nil
end

return buildPackage
